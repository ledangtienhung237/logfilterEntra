<!-- Log Viewer – Clean Rebuild v3 (Hunter-ready) -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Log Viewer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body{background:#fff}
    .table-responsive{max-height:70vh;overflow:auto}
    thead th{position:sticky;top:0;background:#343a40;color:#fff;z-index:2}
    .row-single-factor{background-color:#fff3cd!important}
    .row-5xx{background-color:#f8d7da!important}
    .cols-dropdown{max-height:300px;overflow:auto}
    .icon-title{margin-right:.5rem}
    #detailModal .card{border-radius:.75rem;box-shadow:0 2px 8px rgba(0,0,0,.08)}
    #detailModal h6{font-weight:600}
    .badge-pill{border-radius:50rem}
    .copy-input .input-group-text{min-width:7rem}
  </style>
</head>
<body class="p-4">
  <div class="container-fluid">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
      <h1 class="mb-0">Upload JSON Logs</h1>
      <div class="d-flex gap-2">
        <input class="form-control" type="file" id="fileInput" accept="application/json,.json" />
        <button class="btn btn-outline-secondary" id="clearFilterBtn" title="Clear all filters">Clear Filter</button>
      </div>
    </div>

    <div class="row g-2 align-items-center mb-2">
      <div class="col-12 col-md-6 d-flex gap-2">
        <input class="form-control" type="text" id="searchInput" placeholder="Search logs..." />
      </div>
      <div class="col-12 col-md-6 d-flex justify-content-md-end gap-2">
        <div class="dropdown">
          <button class="btn btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">Columns</button>
          <div class="dropdown-menu p-2 cols-dropdown" id="columnsDropdown"></div>
        </div>
        <button class="btn btn-success" id="exportCSV">Export CSV</button>
        <button class="btn btn-outline-success" id="exportJSON">Export JSON</button>
      </div>
    </div>

    <div class="d-flex justify-content-between align-items-center flex-wrap my-3 gap-2">
      <div class="d-flex align-items-center gap-2">
        <label for="rowsPerPageSelect" class="form-label mb-0">Rows per page:</label>
        <select id="rowsPerPageSelect" class="form-select form-select-sm w-auto">
          <option value="25">25</option>
          <option value="50" selected>50</option>
          <option value="100">100</option>
        </select>
      </div>
      <nav><ul class="pagination pagination-sm justify-content-end mb-0" id="pagination"></ul></nav>
    </div>
    <div id="entriesInfo" class="text-muted small my-2"></div>

    <div class="table-responsive">
      <table class="table table-striped table-bordered w-100" id="mainTable">
        <thead class="table-dark"><tr id="tableHeader"></tr></thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Modal (static markup) -->
  <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="detailModalLabel">Log Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3" id="detailCards"><!-- filled by JS --></div>
          <details class="mt-3">
            <summary class="fw-semibold">Raw JSON</summary>
            <pre id="detailJson" class="bg-light p-3 border rounded-3" style="max-height:45vh;overflow:auto"></pre>
          </details>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ====== State ======
    let debounceTimer, sortField=null, sortOrder='asc';
    let jsonData=[], filteredData=[], visibleFields=[];
    let currentPage=1, rowsPerPage=50;
    let selectedLog=null;

    const defaultFields=[
      'createdDateTime','userDisplayName','userPrincipalName','appDisplayName','clientAppUsed',
      'browser','operatingSystem','ipAddress','conditionalAccessStatus',
      'authenticationRequirement','isCompliant','isManaged','trustType',
      'riskLevelDuringSignIn','sessionId','correlationId','status.errorCode','status.additionalDetails',
      'location.city','location.state','location.countryOrRegion'
    ];

    // ====== Utils ======
    const deepGet=(obj,path)=>path.split('.').reduce((a,k)=>a&&a[k]!==undefined?a[k]:undefined,obj);
    function getValue(log,field){
      if(field==='browser') return log.deviceDetail?.browser ?? '';
      if(field==='operatingSystem') return log.deviceDetail?.operatingSystem ?? '';
      // try both location and signInLocation
      if(field.startsWith('location.')) return deepGet(log,'location.'+field.split('.').slice(1).join('.')) ?? deepGet(log,'signInLocation.'+field.split('.').slice(1).join('.')) ?? '';
      return deepGet(log,field) ?? '';
    }

    const showToast=(msg)=>{const div=document.createElement('div');div.className='toast align-items-center text-bg-dark border-0 position-fixed bottom-0 end-0 m-3';div.role='alert';div.innerHTML=`<div class="d-flex"><div class="toast-body">${msg}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;document.body.appendChild(div);const t=new bootstrap.Toast(div,{delay:1500});t.show();setTimeout(()=>div.remove(),1800)};

    const copyToClipboard=(text)=>{navigator.clipboard?.writeText(text).then(()=>showToast('Copied')).catch(()=>{const ta=document.createElement('textarea');ta.value=text;document.body.appendChild(ta);ta.select();document.execCommand('copy');ta.remove();showToast('Copied');});};

    function formatLoc(log){
      const loc = log.location || log.signInLocation || {};
      const parts=[loc.city,loc.state,loc.countryOrRegion].filter(Boolean);
      return parts.join(', ') || '(unknown)';
    }

    function getCoords(log){
      const geo=(log.location?.geoCoordinates)||(log.signInLocation?.geoCoordinates)||{};
      const {latitude,longitude}=geo; if(isFinite(latitude)&&isFinite(longitude)) return {lat:+latitude,lon:+longitude};
      return null;
    }

    function haversine(lat1,lon1,lat2,lon2){const R=6371;const toRad=x=>x*Math.PI/180;const dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1);const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));}

    // ====== File load ======
    document.getElementById('fileInput').addEventListener('change',function(){
      const file=this.files[0]; if(!file) return;
      const reader=new FileReader();
      reader.onload=e=>{try{
        const data=JSON.parse(e.target.result);
        jsonData=Array.isArray(data)?data:(Array.isArray(data.value)?data.value:[]);
        filteredData=[...jsonData];
        const detected=detectColumns(jsonData);
        visibleFields=[...new Set([...defaultFields,...detected])];
        buildColumnsDropdown();
        renderTable(); renderPagination();
      }catch(err){showToast('Invalid JSON');}};
      reader.readAsText(file);
    });

    // ====== Column handling ======
    function detectColumns(data){
      const s=new Set();
      data.slice(0,50).forEach(row=>{Object.keys(row||{}).forEach(k=>s.add(k)); if(row.status){s.add('status.errorCode');s.add('status.additionalDetails');} if(row.deviceDetail){s.add('browser');s.add('operatingSystem');} if(row.location||row.signInLocation){s.add('location.city');s.add('location.state');s.add('location.countryOrRegion');}});
      return [...s];
    }

    function buildColumnsDropdown(){
      const menu=document.getElementById('columnsDropdown'); menu.innerHTML='';
      visibleFields.forEach(field=>{
        const id='col_'+field.replace(/[^a-z0-9]/gi,'_');
        const item=document.createElement('div'); item.className='form-check';
        item.innerHTML=`<input class="form-check-input" type="checkbox" id="${id}" data-field="${field}" checked><label class="form-check-label" for="${id}">${field}</label>`;
        item.querySelector('input').addEventListener('change',e=>{const f=e.target.dataset.field; if(e.target.checked){if(!visibleFields.includes(f)) visibleFields.push(f);} else {visibleFields=visibleFields.filter(x=>x!==f);} renderTable();});
        menu.appendChild(item);
      });
    }

    // ====== Search ======
    document.getElementById('searchInput').addEventListener('input',function(){
      clearTimeout(debounceTimer);
      debounceTimer=setTimeout(()=>{
        const term=this.value.toLowerCase().trim();
        if(!term){filteredData=[...jsonData];}
        else {filteredData=jsonData.filter(log=>visibleFields.some(f=>String(getValue(log,f)).toLowerCase().includes(term)));}
        currentPage=1; renderTable(); renderPagination();
      },300);
    });

    document.getElementById('clearFilterBtn').addEventListener('click',()=>{
      document.getElementById('searchInput').value=''; filteredData=[...jsonData]; currentPage=1; renderTable(); renderPagination();
    });

    // ====== Export ======
    document.getElementById('exportCSV').addEventListener('click',()=>{
      if(!filteredData.length) return;
      const header=visibleFields.join(',');
      const rows=filteredData.map(log=>visibleFields.map(f=>'"'+String(getValue(log,f)).replace(/"/g,'""')+'"').join(','));
      downloadBlob([header,...rows].join('\n'),'logs_export.csv','text/csv;charset=utf-8;');
    });
    document.getElementById('exportJSON').addEventListener('click',()=>{
      downloadBlob(JSON.stringify(filteredData,null,2),'logs_filtered.json','application/json');
    });
    function downloadBlob(content,filename,type){const blob=new Blob([content],{type});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=filename;document.body.appendChild(a);a.click();a.remove();}

    // ====== Sort/Pagination/Table ======
    function handleSort(field){ if(sortField===field){sortOrder=sortOrder==='asc'?'desc':'asc';} else {sortField=field;sortOrder='asc';}
      filteredData.sort((a,b)=>{const av=getValue(a,field),bv=getValue(b,field); return sortOrder==='asc'?String(av).localeCompare(String(bv)):String(bv).localeCompare(String(av));});
      currentPage=1; renderTable(); renderPagination(); }

    document.getElementById('rowsPerPageSelect').addEventListener('change',function(){rowsPerPage=parseInt(this.value,10)||50; currentPage=1; renderTable(); renderPagination();});

    function renderTable(){
      const thead=document.getElementById('tableHeader'); const tbody=document.getElementById('tableBody'); thead.innerHTML=''; tbody.innerHTML='';
      visibleFields.forEach(f=>{const th=document.createElement('th'); th.textContent=f; th.style.cursor='pointer'; th.title='Sort'; th.addEventListener('click',()=>handleSort(f)); thead.appendChild(th);});
      const start=(currentPage-1)*rowsPerPage, end=Math.min(start+rowsPerPage,filteredData.length);
      filteredData.slice(start,end).forEach((log,i)=>{const tr=document.createElement('tr'); if(log.authenticationRequirement==='singleFactorAuthentication') tr.classList.add('row-single-factor'); const err=log.status?.errorCode; if(err && String(err).startsWith('5')) tr.classList.add('row-5xx'); tr.addEventListener('click',()=>openDetailModal(start+i)); visibleFields.forEach(f=>{const td=document.createElement('td'); const v=getValue(log,f); td.textContent=(v===null||v===undefined)?'':v; tr.appendChild(td);}); tbody.appendChild(tr);});
      document.getElementById('entriesInfo').textContent = filteredData.length?`Showing ${start+1}–${end} of ${filteredData.length} entries`:'No entries';
    }

    function renderPagination(){const ul=document.getElementById('pagination'); ul.innerHTML=''; const pages=Math.max(1,Math.ceil(filteredData.length/rowsPerPage)); const add=(label,disabled,on,active)=>{const li=document.createElement('li'); li.className=`page-item${disabled?' disabled':''}${active?' active':''}`; const a=document.createElement('a'); a.className='page-link'; a.href='#'; a.textContent=label; a.onclick=e=>{e.preventDefault(); if(!disabled) on();}; li.appendChild(a); ul.appendChild(li);}; add('Prev',currentPage===1,()=>{currentPage--;renderTable();renderPagination();}); for(let p=1;p<=pages;p++) add(String(p),false,()=>{currentPage=p;renderTable();renderPagination();},p===currentPage); add('Next',currentPage===pages,()=>{currentPage++;renderTable();renderPagination();}); }

    // ====== Detail modal ======
    function badge(text, cls){return `<span class="badge ${cls} badge-pill">${text}</span>`}
    function copyGroup(label, val){const id=Math.random().toString(36).slice(2); return `<div class="input-group input-group-sm mb-2 copy-input"><span class="input-group-text">${label}</span><input type="text" class="form-control" value="${val||''}" id="${id}" readonly><button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard(document.getElementById('${id}').value)">Copy</button></div>`}

    function openDetailModal(idx){
      selectedLog=filteredData[idx]; if(!selectedLog) return;
      const ok=(selectedLog.status?.errorCode===0||selectedLog.status?.errorCode==='0');
      const resultB = ok ? badge('Success','text-bg-success') : (selectedLog.status?.errorCode!==undefined? badge('Error '+selectedLog.status.errorCode,'text-bg-danger') : badge('Unknown','text-bg-secondary'));
      const compliantB = selectedLog.isCompliant===true? badge('Compliant','text-bg-success') : (selectedLog.isCompliant===false? badge('Non-compliant','text-bg-danger'): badge('Compliance N/A','text-bg-secondary'));
      const managedB = selectedLog.isManaged===true? badge('Managed','text-bg-success') : (selectedLog.isManaged===false? badge('Unmanaged','text-bg-danger'): badge('Managed N/A','text-bg-secondary'));
      const tokenTxt = selectedLog.signInTokenProtectionStatus || 'N/A';
      const tokenB = /protected/i.test(tokenTxt) ? badge(tokenTxt,'text-bg-success') : (tokenTxt==='N/A'? badge('Token: N/A','text-bg-secondary') : badge(tokenTxt,'text-bg-warning'));

      const left = `
        <div class="col-12 col-lg-6">
          <div class="card h-100"><div class="card-body">
            <h6 class="mb-2">Overview</h6>
            <div class="mb-2">${resultB} &nbsp; ${compliantB} &nbsp; ${managedB} &nbsp; ${tokenB}</div>
            ${copyGroup('UPN', selectedLog.userPrincipalName)}
            ${copyGroup('IP', selectedLog.ipAddress)}
            ${copyGroup('CorrelationId', selectedLog.correlationId)}
            <div class="small text-muted">Time: ${selectedLog.createdDateTime||''}</div>
            <div class="small text-muted">App: ${selectedLog.appDisplayName||''}</div>
            <div class="small text-muted">Client: ${selectedLog.clientAppUsed||''}</div>
            <div class="small text-muted">Location: ${formatLoc(selectedLog)}</div>
          </div></div>
        </div>`;

      const right = `
        <div class="col-12 col-lg-6">
          <div class="card h-100"><div class="card-body">
            <h6 class="mb-2">Device & Authentication</h6>
            <div class="mb-1">OS: ${selectedLog.deviceDetail?.operatingSystem || '(empty)'} </div>
            <div class="mb-1">Browser: ${selectedLog.deviceDetail?.browser || '(empty)'} </div>
            <div class="mb-1">Trust: ${selectedLog.trustType || '(empty)'} </div>
            <div class="mb-1">Auth Requirement: ${selectedLog.authenticationRequirement || '(empty)'} </div>
            <div class="mb-1">Auth Strength: ${selectedLog.authenticationStrength?.authenticationStrengthResult || '(empty)'} </div>
            <div class="mb-1">Details: ${selectedLog.status?.additionalDetails || '(empty)'} </div>
            <button class="btn btn-primary btn-sm mt-2" type="button" id="btnAnalyzeTravel">Analyze travel for this user</button>
          </div></div>
        </div>`;

      const travel = `
        <div class="col-12">
          <div class="card"><div class="card-body">
            <div class="d-flex align-items-center gap-2 mb-2">
              <h6 class="mb-0">Travel anomalies</h6>
              <div class="ms-auto d-flex align-items-center gap-2">
                <label class="form-label mb-0 small" for="windowHours">Window (h):</label>
                <input type="number" id="windowHours" class="form-control form-control-sm" value="24" min="1" style="width:80px">
              </div>
            </div>
            <div id="travelFindings" class="small"></div>
          </div></div>
        </div>`;

      document.getElementById('detailCards').innerHTML = left + right + travel;
      document.getElementById('detailJson').textContent = JSON.stringify(selectedLog,null,2);
      const m=new bootstrap.Modal(document.getElementById('detailModal')); m.show();

      document.getElementById('btnAnalyzeTravel').onclick=()=>{
        const hours=parseInt(document.getElementById('windowHours').value,10)||24;
        analyzeImpossibleTravel(selectedLog.userPrincipalName, hours);
      };
    }

    function analyzeImpossibleTravel(user, windowHours){
      const out=document.getElementById('travelFindings'); if(!user){out.innerHTML='<span class="text-muted">No user.</span>';return}
      const since=Date.now()-windowHours*3600000;
      const rows=jsonData.filter(l=>l.userPrincipalName===user && Date.parse(l.createdDateTime||0)>=since).sort((a,b)=>Date.parse(a.createdDateTime||0)-Date.parse(b.createdDateTime||0));
      if(rows.length<2){out.innerHTML='<span class="text-muted">Not enough sign-ins in window.</span>';return}
      const findings=[];
      for(let i=1;i<rows.length;i++){
        const A=rows[i-1], B=rows[i];
        const t1=Date.parse(A.createdDateTime||0), t2=Date.parse(B.createdDateTime||0); if(!t1||!t2) continue;
        const minutes=(t2-t1)/60000; if(minutes<0) continue;
        let distKm=null; const c1=getCoords(A), c2=getCoords(B);
        if(c1&&c2){distKm=haversine(c1.lat,c1.lon,c2.lat,c2.lon);} else {
          const aC=(A.location||A.signInLocation||{}).countryOrRegion; const bC=(B.location||B.signInLocation||{}).countryOrRegion;
          if(aC && bC && aC!==bC) distKm=1000; // rough long haul
        }
        if(distKm===null) continue;
        const speed=minutes>0? distKm/(minutes/60) : Infinity;
        const impossible = (minutes<=5 && distKm>=50) || speed>=1000; // conservative thresholds
        if(impossible){
          findings.push({from:formatLoc(A), to:formatLoc(B), when:new Date(t2).toISOString(), minutes:minutes.toFixed(1), dist:distKm.toFixed(1), speed:isFinite(speed)?speed.toFixed(0):'∞'});
        }
      }
      if(!findings.length){ out.innerHTML='<span class="text-success">No impossible travel detected with available data.</span>'; return; }
      out.innerHTML = `<div class="table-responsive"><table class="table table-sm table-bordered mb-0">
        <thead class="table-light"><tr><th>#</th><th>From</th><th>To</th><th>Time gap (min)</th><th>Distance (km)</th><th>Speed (km/h)</th></tr></thead>
        <tbody>${findings.map((r,i)=>`<tr class="table-warning"><td>${i+1}</td><td>${r.from}</td><td>${r.to}</td><td>${r.minutes}</td><td>${r.dist}</td><td>${r.speed}</td></tr>`).join('')}</tbody>
      </table></div>`;
    }
  </script>
</body>
</html>
